<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Shorty — Мои ссылки</title>
    <link rel="stylesheet" href="assets/css/styles.css"/>
    <style>
        body { background:#0f172a; color:#e5e7eb; font-family: Inter,system-ui,sans-serif; margin:0; }
        header, .container { max-width: 980px; margin: 0 auto; padding: 16px; }
        .card { background:#111827; border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
        .row { display:grid; grid-template-columns: 1fr auto; align-items:center; gap:12px; }
        .table{ width:100%; border-collapse: collapse; }
        .table th,.table td{ border-bottom:1px solid #1f2937; padding:8px 10px; font-size:14px; vertical-align: top; }
        a.ghost{ background:transparent; border:1px solid #374151; color:#cbd5e1; padding:6px 10px; border-radius:10px; text-decoration:none; }
        .muted{ color:#94a3b8; }
        .short { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    </style>
</head>
<body>
<header>
    <div class="row" style="grid-template-columns:auto 1fr auto;">
        <h1 style="margin:0">Мои ссылки</h1>
        <div></div>
        <nav><a class="ghost" href="index.html">На главную</a></nav>
    </div>
</header>

<main class="container">
    <div class="card">
        <div class="row">
            <div id="meta" class="muted">Загрузка…</div>
            <div>
                <button id="prev" class="ghost">«</button>
                <span id="page" class="muted">1</span>
                <button id="next" class="ghost">»</button>
            </div>
        </div>

        <div style="overflow:auto; margin-top:10px">
            <table class="table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Короткая</th>
                    <th>Цель</th>
                    <th>Создана</th>
                    <th>Активна</th>
                    <th>Истекает</th>
                    <th>Лимит</th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="rows"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    const TOKEN_KEY = "shorty_token";
    function token() { return localStorage.getItem(TOKEN_KEY); }
    let page = 0, size = 20;

    async function load() {
        const res = await fetch(`/api/links/me?page=${page}&size=${size}`, {
            headers: { "Authorization": "Bearer " + token() }
        });
        const meta = document.querySelector("#meta");
        const rows = document.querySelector("#rows");
        const pageLabel = document.querySelector("#page");

        if (!res.ok) { meta.textContent = `Ошибка ${res.status}`; return; }

        const data = await res.json(); 
        meta.textContent = `Всего: ${data.totalElements} • страниц: ${data.totalPages}`;
        pageLabel.textContent = (page + 1);

        rows.innerHTML = "";
        for (const l of data.content) {
            const slug = l.slug;
            const shortUrl = `${location.origin}/r/${slug}`;
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${l.id}</td>
        <td class="short"><a href="${shortUrl}" target="_blank">${shortUrl}</a></td>
        <td>${escapeHtml(l.targetUrl || "")}</td>
        <td>${l.createdAt ?? ""}</td>
        <td>${l.isActive ?? ""}</td>
        <td>${l.expiresAt ?? ""}</td>
        <td>${l.maxClicks ?? ""}</td>
        <td><a class="ghost" href="analytics.html?id=${l.id}">Подробнее</a></td>
      `;
            rows.appendChild(tr);
        }
    }

    document.querySelector("#prev").onclick = () => { if (page > 0) { page--; load(); } };
    document.querySelector("#next").onclick = () => { page++; load(); };

    function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    load();
</script>
</body>
</html>
