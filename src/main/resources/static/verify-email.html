<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shorty — Подтверждение e-mail</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <style>
        body{margin:0;background:#0f172a;color:#e5e7eb;font-family:Inter,system-ui,sans-serif}
        .wrap{max-width:560px;margin:80px auto;padding:0 16px}
        h1{margin:0 0 16px 0}
        .card{background:#111827;border-radius:16px;padding:20px 20px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
        .row{display:grid;grid-template-columns:1fr;gap:12px}
        input{width:100%;padding:12px 14px;border-radius:12px;border:0;background:#0b1220;color:#e5e7eb}
        .btn{background:#22c55e;color:#052e16;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
        .muted{color:#94a3b8}
        a{color:#60a5fa}
        #toast{position:fixed;right:16px;bottom:16px;background:#22c55e;color:#052e16;padding:8px 14px;border-radius:10px;opacity:0;transition:.25s}
        .success{color:#86efac}
        .error{color:#fca5a5}
    </style>
</head>
<body>
<div class="wrap">
    <h1>Подтверждение e-mail</h1>

    <div class="card">
        <div class="row">
            <div id="state" class="muted">Проверяем ссылку…</div>
            <button id="btn-go-login" class="btn" style="display:none">Перейти ко входу</button>
        </div>
    </div>

    <div id="resend-card" class="card" style="display:none">
        <h2 style="margin:0 0 8px 0">Письмо не пришло?</h2>
        <div class="row">
            <input id="resend-email" type="email" placeholder="Ваш e-mail" autocomplete="email" />
            <button id="btn-resend" class="btn">Отправить снова</button>
            <div id="resend-note" class="muted"></div>
        </div>
    </div>

    <div class="card" style="margin-top:16px">
        <div class="muted">
            Уже подтвердили? <a href="login.html">Войти</a>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    const $ = (id)=>document.getElementById(id);
    const el = {
        state: $("state"),
        btnLogin: $("btn-go-login"),
        cardResend: $("resend-card"),
        email: $("resend-email"),
        resendBtn: $("btn-resend"),
        resendNote: $("resend-note"),
        toast: $("toast"),
    };

    function toast(msg){
        if(!el.toast){ console.log(msg); return; }
        el.toast.textContent = msg;
        el.toast.style.opacity = "1";
        setTimeout(()=> el.toast.style.opacity = "0", 1800);
    }

    async function api(path, { method="GET", body, headers={} } = {}){
        const url = `${window.location.origin}${path}`;
        const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json", ...headers },
            body: body ? JSON.stringify(body) : undefined,
            credentials: "include"
        });
        const txt = await res.text();
        let data = null;
        try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
        if(!res.ok) throw new Error((data && data.error) || data || `HTTP ${res.status}`);
        return data;
    }

    const params = new URLSearchParams(location.search);
    const token = params.get("token");
    const prefillEmail = params.get("email");

    if (prefillEmail) el.email.value = prefillEmail;

    async function confirmByToken(){
        if(!token){
            el.state.innerHTML = 'Мы отправили письмо на вашу почту. Перейдите по ссылке в письме, чтобы подтвердить e-mail.';
            el.cardResend.style.display = "block";
            return;
        }
        try{
            await api("/api/auth/verify/confirm?token="+encodeURIComponent(token));
            el.state.innerHTML = '<span class="success">E-mail подтверждён. Теперь можно войти.</span>';
            el.btnLogin.style.display = "inline-block";
        }catch(e){
            el.state.innerHTML = '<span class="error">Ссылка недействительна или просрочена.</span>';
            el.cardResend.style.display = "block";
        }
    }

    async function resend(){
        const email = (el.email.value || "").trim();
        if(!email){ toast("Введите e-mail"); return; }
        try{
            await api("/api/auth/verify/request", { method:"POST", body:{ email } });
            el.resendNote.textContent = "Ссылка отправлена. Проверьте вашу почту.";
            toast("Ссылка отправлена");
        }catch(e){
            el.resendNote.textContent = "Ошибка отправки. Попробуйте позже.";
            toast(String(e.message || "Ошибка отправки"));
        }
    }

    el.resendBtn.addEventListener("click", resend);
    el.btnLogin.addEventListener("click", ()=> location.href="login.html");

    (async function init(){
        await confirmByToken();
    })();
</script>
</body>
</html>
